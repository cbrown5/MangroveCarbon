---
title: "Mangrove Carbon Emission Simulator"
runtime: shiny
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    css: theme-lumen.css
---

<style> 
a{
  color:#00cc00;
}

a:hover, a:focus{
color:#006600;
}

.navbar {
  background-color:#00b300;
  border-color:white;
}
.navbar-brand {
}
.nav-tabs-custom > .nav-tabs > li.active {
border-top-color:#00b300;
}
</style>  

```{r global, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(plotly)
library(shiny)
library(flexdashboard)
library(leaflet)
```

SEe: https://rstudio.github.io/leaflet/shiny.html

Column {.sidebar}
--------------------------------------------------

```{r inputs, echo=FALSE, fig.width=20}
inputPanel(
   # Input: Slider for the number of bins ----
      sliderInput(inputId = "d",
                  label = "Deforestation rate (per year)",
                  min = 0.005,
                  max = 0.9,
                  value = 0.05)
    ,
    numericInput(inputId = "A0",
                    label = "Area of mangroves (hectares)",
                    value = 1000)
    ,
    textInput(inputId = "mGC02_ha",
                label = "Carbon Stock (MgC02 per hectare)",
                value = "57, 776" #Values from Adame et al. 2018
                ),
   textInput(inputId = "emname",
                label = "Scenario label",
                value = "Reported, Actual"
                )
      ,
    selectInput(inputId = "units",
                label = "Units",
                choices = c("Megatonnes", "Tonnes", "Cars per annum"),
                multiple = FALSE)
    ,
    sliderInput(inputId = "yrmax",
                label = "Years",
                min = 1,
                max = 200,
                value = 50)
    ,
    sliderInput(inputId = "rd",
                label = "Emission rate (per year)",
                min = 0.01,
                max = 1,
                value = 0.1)
   ,
    selectInput(inputId = "palettechoice",
                label = "Color Palette",
                choices = list("Greens" = "Greens", 
                               "Reds" = "Reds", 
                               "Blues" = "Blues", 
                               "Purples" = "Purples", 
                               "Brown-Green" = "BrBG", 
                               "Spectral" = "Spectral", 
                               "Multi" = "Dark2", 
                               "Set1" = "Set1"), 
                  selected = "Greens")
)



```



Row {.tabset .tabset-fade data-height=350} 
-------------------------------------------------- 

### About 

```{r}
m <- leaflet() %>%
  addTiles() %>%  # Add default OpenStreetMap map tiles
  addMarkers(lng=174.768, lat=-36.852, popup="The birthplace of R")
m
```


### Instructions  
Use the sliders and inputs on the left to explore how carbon emissions change under different deforestation rates.  You can enter the potential carbon dioxide emissions in the 'Carbon Stock' box. Seperate multiple values by commas (up to 9 allowed).  
 


### Model description and contact  
Contact Chris Brown (chris.brown@griffith.edu.au) if you have any queries about the web app. 


Row {data-height=650}
-------------------------------------------------- 

### Emissions from mangrove deforestation
```{r fig.width = 12}

calcdef <- function(tsteps, A1, C, d, r){
    if (d == r) d <- d+(d/10000)
    A1 * C - ((exp(-tsteps*r) * (A1*C*r*exp(tsteps*r) - A1 * C*d*exp(tsteps*d)))/ 
                (exp(tsteps * d)*r - d*exp(tsteps*d)))
  }
    renderPlotly({
      if(input$units == "Megatonnes") denom <- 1E6
      if(input$units == "Cars per annum") denom <- 4.7
      if(input$units == "Tonnes") denom <- 1

      
      Cd <- as.numeric(unlist(strsplit(input$mGC02_ha, split = ",")))
      emname <- unlist(strsplit(input$emname, split = ","))
      if (length(emname) < length(Cd)) emname <- rep("", length(Cd))
      nchoices <- length(Cd)
      years <- 0:input$yrmax
      carbon <- NULL

      for (i in 1:nchoices){
        carbon <- c(carbon,
                    list(
                      calcdef(years, input$A0, Cd[i], input$d, input$rd)/denom
                      ))
      }
      emcols <- RColorBrewer::brewer.pal(9, input$palettechoice)[(9-nchoices):9]
      pfont <- list(
        size = 14,
        color = 'black')
      p <- plot_ly(x = years, y = carbon[[1]], name = emname[1], 
                   mode = "lines",
                   line = list(color=emcols[1], width = 4)) %>%
        layout(title = "",
               xaxis = list(title = input$),
               yaxis = list(title =paste0('Cumulative emissions (',input$units,')')), 
               font = pfont)
      for (i in 1:nchoices){
        if (nchoices >1){
        p <- add_trace(p, y = carbon[[i]], name = emname[i], 
                       mode = 'lines',
                    line = list(color=emcols[i], width = 4))}
      }
      p

    })

```




