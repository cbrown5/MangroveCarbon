---
title: "Mangrove Carbon Emission Simulator"
runtime: shiny
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
---

<style> 
a{
  color:#00cc00;
}

a:hover, a:focus{
color:#006600;
}

.navbar {
  background-color:#00b300;
  border-color:white;
}
.navbar-brand {
}
.nav-tabs-custom > .nav-tabs > li.active {
border-top-color:#00b300;
}
</style>  

```{r global, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(plotly)
library(shiny)
library(flexdashboard)
```


Column {.sidebar}
--------------------------------------------------

```{r inputs, echo=FALSE, fig.width=20}
inputPanel(
   # Input: Slider for the number of bins ----
      sliderInput(inputId = "d",
                  label = "Deforestation rate (per year)",
                  min = 0.005,
                  max = 0.9,
                  value = 0.05)
    ,
    numericInput(inputId = "A0",
                    label = "Area of mangroves (hectares)",
                    value = 1000)
    ,
    textInput(inputId = "mGC02_ha",
                label = "Carbon Stock (MgC02 per hectare)",
                value = "57, 776" #Values from Adame et al. 2018
                ),
   textInput(inputId = "emname",
                label = "Scenario label",
                value = "Reported, Actual"
                )
      ,
    selectInput(inputId = "units",
                label = "Units",
                choices = c("Megatonnes", "Tonnes", "Cars per annum"),
                multiple = FALSE)
    ,
    sliderInput(inputId = "yrmax",
                label = "Years",
                min = 1,
                max = 200,
                value = 50)
    ,
    sliderInput(inputId = "rd",
                label = "Emission rate (per year)",
                min = 0.01,
                max = 1,
                value = 0.1)
   ,
    selectInput(inputId = "palettechoice",
                label = "Color Palette",
                choices = list("Greens" = "Greens", 
                               "Reds" = "Reds", 
                               "Blues" = "Blues", 
                               "Purples" = "Purples", 
                               "Brown-Green" = "BrBG", 
                               "Spectral" = "Spectral", 
                               "Multi" = "Dark2", 
                               "Set1" = "Set1"), 
                  selected = "Greens")
)



```



Row {.tabset .tabset-fade data-height=350} 
-------------------------------------------------- 

### About 
Forests store **carbon**, which helps fight climate change. 

Countries measure the amount of carbon stored in their forests and wetlands and use 
that information when calculating their total carbon emissions.  

It' a critical part of determining if they're meeting their obligations under 
international frameworks, like the Paris Climate Agreement.  

However, assessments often overlook the carbon stored in the soils 
beneath forests.  

That's a problem because it's where most of the carbon is actually stored in wetlands like mangrove forests.  

It leads to countries underestimating both their total carbon emissions and 
the true value of protecting their forests.  

[Our research](https://globalwetlandsproject.org) in Mexico shows that mangrove forests store much more carbon than rainforests.  

When the mangrove trees are removed the soil carbon is released too - it's not just the trees.  

This web app is designed to help you explore the contribution of mangrove protection to mitigating emissions. It supports the publication: 
 [Adame et al. The undervalued contribution of mangrove protection in Mexico to carbon emission targets. Conservation Letters](http://onlinelibrary.wiley.com/doi/10.1111/conl.12445/full)
Please cite that publication if you use output from this app or the [associated R package](https://github.com/cbrown5/MangroveCarbon).  

### Instructions  
Use the sliders and inputs on the left to explore how carbon emissions change under different deforestation rates.  You can enter the potential carbon dioxide emissions in the 'Carbon Stock' box. Seperate multiple values by commas (up to 9 allowed).  
 
A few details. All rates are instantaneous values. You can plot the emissions in different units, including in terms of annual car emissions. 'Cars per annum' is an average annual emission rate from cars in the USA. 

Hover over the plot for more options, like the camera icon which lets you save the plot as an image. 


### Model description and contact  
The data used here come from surveys of carbon in soils, trees and dead-wood in Mexicos mangrove forests.The surveys covered Mexico's three major climate regions. The model estimates annual emissions based on the carbon estimates for each region and a rate of forest loss. Forest loss occurs at a constant rate. Carbon dioxide may take some time to be released once a mangrove forest is cleared. The 'Emission rate' slider controls this rate of emissions once an area of forest is lost. Evidence suggests that emissions are lost at a rate of about 10% per year (the default value used here). 

See that publication for further details of the data and models underlying this app.  
[Click here if you want to see the code underneath the hood of this model](http://www.seascapemodels.org/MangroveCarbon/)
The web app was designed by Drs Chris Brown and Fernanda Adame using the R program, RShiny and plotly.  

Design and deployment has been supported by the [Global Wetlands Program at Griffith University](https://globalwetlandsproject.org).  
 
Contact Chris Brown (chris.brown@griffith.edu.au) if you have any queries about the web app. 


Row {data-height=650}
-------------------------------------------------- 

### Emissions from mangrove deforestation
```{r fig.width = 12}

calcdef <- function(tsteps, A1, C, d, r){
    if (d == r) d <- d+(d/10000)
    A1 * C - ((exp(-tsteps*r) * (A1*C*r*exp(tsteps*r) - A1 * C*d*exp(tsteps*d)))/ 
                (exp(tsteps * d)*r - d*exp(tsteps*d)))
  }
    renderPlotly({
      if(input$units == "Megatonnes") denom <- 1E6
      if(input$units == "Cars per annum") denom <- 4.7
      if(input$units == "Tonnes") denom <- 1

      
      Cd <- as.numeric(unlist(strsplit(input$mGC02_ha, split = ",")))
      emname <- unlist(strsplit(input$emname, split = ","))
      if (length(emname) < length(Cd)) emname <- rep("", length(Cd))
      nchoices <- length(Cd)
      years <- 0:input$yrmax
      carbon <- NULL

      for (i in 1:nchoices){
        carbon <- c(carbon,
                    list(
                      calcdef(years, input$A0, Cd[i], input$d, input$rd)/denom
                      ))
      }
      emcols <- RColorBrewer::brewer.pal(9, input$palettechoice)[(9-nchoices):9]
      pfont <- list(
        size = 14,
        color = 'black')
      p <- plot_ly(x = years, y = carbon[[1]], name = emname[1], 
                   mode = "lines",
                   line = list(color=emcols[1], width = 4)) %>%
        layout(title = "",
               xaxis = list(title = "Year"),
               yaxis = list(title =paste0('Cumulative emissions (',input$units,')')), 
               font = pfont)
      for (i in 1:nchoices){
        if (nchoices >1){
        p <- add_trace(p, y = carbon[[i]], name = emname[i], 
                       mode = 'lines',
                    line = list(color=emcols[i], width = 4))}
      }
      p

    })

```




